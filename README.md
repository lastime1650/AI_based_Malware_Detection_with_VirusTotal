# AI_based_Malware_Detection_with_VirusTotal
This source code is entirely based on Python3.9, based on the VirusTotal API and the pefile module, and uses the Tensorflow AI module to detect malware.

기존 pefile모듈 기반 정적분석과 Virus_Total API를 결합하여 데이터세트를 생성하고, AI 모델을 구축하는 프로젝트입니다.
또한 CSV의 접근성을 높이기 위해, Parsing_CSV.py를 사용하여 보다 쉽게 CSV파일을 추가,가져오기,바꾸기가 가능합니다. 

---

# **AI 훈련을 위한 X데이터의 구조**

![initial](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/img_for_README/X_data_struct.png)

---
# **바로 사용하려면?**

MAIN 디렉터리내 모든 파일을 다운받고, 

![initial](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/img_for_README/main3.png)

**[MAIN/NEW_AI_instance.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/NEW_AI_instance.py)**을 열어 인스턴스를 알맞게 생성합니다. Start_Train()호출하여 예측에 필요한 데이터를 생성해야합니다. 그런 다음 Start_Prediction() 호출하면 됩니다. 

멀티스레딩환경에서도 사용할 수 있도록 threading.Lock()을 가지고 상호배제를 추가하였으며, 용도는 "클라우드 AI 분석 서버 서비스" 운영목적입니다. ( 서버를 열지 않고 사용하려는 경우는, 상호배제가 필요없습니다. ) 인스턴스를 생성할 때 요구하는 VirusTotal API값과, Prediction할 때 요구하는 VirusTotal API값이 다르다는 것 (인자변수명이 다름)을 알 수 있을 것입니다. Prediction시 X데이터를 생성할 때, API를 가지고 X데이터에 추가하기 때문에 필요합니다. ( 만약 없는 경우 이미 정해진 길이 [0] *937 으로 모두 0으로 처리됩니다. 

NEW_AI_instance.py 구조는 다음과 같습니다.

![initial](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/img_for_README/main1.png)

---

# **장점이 있는가?**

1. VirustTotal의 API를 이용하여 분석을 요청하는 횟수는 제한적입니다. 이것에 대한 비용을 줄일 수 있는 방안을 모색해보았으며, 그 결과 [VT_analysed.csv](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/VT_analysed.csv) CSV파일이 탄생하였습니다. Start_Train() 훈련하거나, Start_Prediction()으로 예측을 할 때 무조건 수행해야 하는 VT분석의 결과를 CSV에 저장하는 방식입니다. 이 덕분에, 조금이라도 API의 사용 횟수를 줄이는데 기여했습니다.

2. 훈련속도를 위해 scikit-learn 모듈의 MinMaxScaler()를 이용하여 fit하기 직전의 X데이터를 정규화합니다. 모든 X의 데이터를 0.0 ~ 1.0 사이의 값으로 나타내는 스케일링 작업을 합니다. 

---

# **단점은 무엇인가?**

현재 단점은 다음과 같습니다. 

1. 모델 자동화 생성하는 부분입니다. 적절하지 않게 DropOut 레이어를 추가될 수 있는 점이며, 좀 더 정확하게 모델을 자동적으로 구축하는 방법을 모색해야합니다.

2. Prediction 이 후의 예측된 y값을 **훈련에 사용할 CSV의 row에 포함**되는 부분입니다.(만약 같은 SHA256의 경우, 해당 row의 y값을 갱신해버립니다.) 이 경우는 자동적으로 데이터세트를 만드는 방식이라, **장점**일 수도 있겠지만, 데이터 세트가 부족하여 예측력이 떨어진다면 오히려 독이될 수 있습니다. 

---

# 어떻게 구성되어 있는가?

## **1. NEW_AI_instance.py([MAIN/NEW_AI_instance.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/NEW_AI_instance.py))**
  
시작점이 되는 모듈이며 사용하려는 경우, 최초시 인스턴스를 만들고 **Start_Train()** 

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/a9f79c65bc152ef235aa736d988563e4a194f74b/MAIN/NEW_AI_instance.py#L44

메서드를 먼저 호출하세요.

그런 다음, DISK에 저장된 X,y,Scaler,model

**X**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/bbe22880a5a6a545af15c24f09df717763e8c572/MAIN/Make_X_only_EXE.py#L267

**y**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/bbe22880a5a6a545af15c24f09df717763e8c572/MAIN/Make_X_only_EXE.py#L270

**Scaler**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/bbe22880a5a6a545af15c24f09df717763e8c572/MAIN/NEW_AI_instance.py#L129

**Model**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/bbe22880a5a6a545af15c24f09df717763e8c572/MAIN/NEW_AI_instance.py#L118

기반으로 Start_Prediction() 호출 후 

**Start_Prediction()**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/bbe22880a5a6a545af15c24f09df717763e8c572/MAIN/NEW_AI_instance.py#L134

X데이터를 구축하고 예측할 수 있습니다.

<br/><br/>


## **2. PE_IMAGE_SIGNATRUEs.py([MAIN/PE_IMAGE_SIGNATRUEs.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/PE_IMAGE_SIGNATRUEs.py))**

EXE실행프로그램을 pefile모듈을 이용하여 시그니처 특성을 뽑아, X데이터의 일부를 생성합니다.

크게 **2가지**의 함수로 이루어져 있습니다.

**[1/2]DLL,API,SECTION 추출하는 함수**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/411fefabadbcc6941f4d505b082cf449da118e43/MAIN/PE_IMAGE_SIGNATRUEs.py#L86

**[2/2]PE헤더를 기반으로 추출하는 함수**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/411fefabadbcc6941f4d505b082cf449da118e43/MAIN/PE_IMAGE_SIGNATRUEs.py#L120

<br/><br/>

## **3. Make_X_only_EXE.py([MAIN/Make_X_only_EXE.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/Make_X_only_EXE.py))**

NEW_AI_instance.py에서 호출받는 함수들입니다. EXE프로그램(Path) 1개당 X데이터를 생산하는 작업을 합니다. 

크게 **3가지** 함수가 존재합니다.

**[1/3]예측을 위한 X데이터 생성 함수**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/12bf8ee23093a36a911784f94d6201eb7022830c/MAIN/Make_X_only_EXE.py#L28

**[2/3]훈련을 위한 X,y데이터 생성 함수**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/12bf8ee23093a36a911784f94d6201eb7022830c/MAIN/Make_X_only_EXE.py#L117

**[3/3]훈련을 위한 y데이터, one-hot 인코드를 생성하는 함수**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/12bf8ee23093a36a911784f94d6201eb7022830c/MAIN/Make_X_only_EXE.py#L11

<br/><br/>

## **4. Model_Configure.py([MAIN/Model_Configure.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/Model_Configure.py))**

Tensorflow의 Functional 기능을 이용하여 모델 Layer 하나하나 변수에 지속적으로 저장해서 모델을 **자동화** 생성하는 함수입니다. ( 자동화 생성의 기준은 parameter로 받는 길이를 기반으로 생성됩니다. )

**[1/1]모두 생성된 X,y를 가지고 자동적으로 모델을 return하는 함수**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/fbd7f60923ad483d5eed31911b8b042e941350d1/MAIN/Model_Configure.py#L22

<br/><br/>

## **5. virus_total_api.py([MAIN/virus_total_api.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/virus_total_api.py))**

이 모듈은 목적에 맞게 virust_total을 편리하게 사용하기 위하여 Class로 개발되었습니다.

**[1/2]VirusTotal_class 클래스**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/eae3967ad5d603e0b25cc214949b88611ca8f174/MAIN/virus_total_api.py#L45

가장 중요한 준비물은 **유효한 VirusTotal str(API값)**이며, 이후의 기능은 메서드들이 알아서 처리합니다.

**[2/2]생성자, API를 받아야만 인스턴스로 사용할 수 있다**

모듈은 다음과 같이 동작합니다.

1. API를 얻어 인스턴스 생성
2. Start_Scan() 호출하여, EXE프로그램의 바이너리와 SHA256 를 준비합니다.
3. request모듈을 이용하여 EXE프로그램의 SHA256값을 /files/ API경로에 **GET** 방식으로 **x-apikey**파라미터에 API값을 담아 전송합니다.
4. 응답은 무조건 JSON으로 받습니다. JSON응답에서 **NotFoundError**가 **['error']['code']**의 value로 저장되어 있는 경우, **이미 이전에 스캔이 완료된 파일**임을 알 수 있습니다.
5. 만약 아닌 경우, **API를 통한 VT분석이 필요**한 상황이기에, /files/경로에 **POST** 방식으로 **file**이름의 body파라미터에 EXE바이너리를 집어넣고, **x-apikey**파라미터에 자신의 API값을 넣어 분석 요청합니다.
6. (5)번에서 파일을 보내면, **['data']['id']** key에 분석 현황을 알 수 있는 **analysis_id**를 받게 됩니다. ( 받아야함 )
7. (5)번에서 파일을 보내고, 분석 결과는 **바로 나오지 않습니다** 이때, 먼저 **GET**방식으로 똑같이 API를 담고, /analyses/{analysis_id}경로에 요청을 보낸다음 **['data']['attributes']['status']** 의 값이 **queued** 가 아닐 때까지 반복적으로 확인해야합니다. ( 오래걸림 )
8. (7)번이 완료되면, 분석결과가 JSON형태로 받게 됩니다.
9. 이때 JSON을 list형태로 변환하도록 self.Start_Analyse() 메서드를 호출하면 됩니다.
10. 추출하는 정보는 다음과 같습니다.

### 1. 파일 SHA256

### 2. last_analysis_results(분석엔진)

### 3. last_analysis_stats(분석엔진 총평)

### 4. total_votes(득표수)

![initial](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/img_for_README/main2.png)

**list**형태로 정리하기 위한 Parsing절차이며, 이 즉시 파싱된 list변수를 활용하여 데이터세트를 만들어야합니다.

데이터세트는 "Vt_analyse_data_to_DeepLearning_data.py" 아래 설명에서 나온거와 같이 생성됩니다.


<br/><br/>

## **6. Vt_analyse_data_to_DeepLearning_data.py([Vt_analyse_data_to_DeepLearning_data.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/Vt_analyse_data_to_DeepLearning_data.py))**

VirusTotal_class클래스의 파싱 결과 값으로는 바로 X데이터로 활용될 수 없으며, 활용하기 위해서는 숫자로 치환하는 처리를 진행합니다.

이러한 방식을 하는 이유는, X데이터의 길이는 항상 **같아야 하기 때문**입니다.

내부의 **ALL**  변수가 저의 답입니다.

result_X 변수가 X데이터의 일부가 되며, ALL길이만큼 일치하면 1 아니면 0을 취하는 방식과, 득표수의 경우는 그대로 값을 넣는 방식을 취합니다.




<br/><br/>

## **7. Parsing_CSV.py([MAIN/Parsing_CSV.py](https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/main/MAIN/Parsing_CSV.py))**

간편한 CSV 편집 모듈입니다. 편집 방식은 pd 모듈을 이용하여 **list**타입으로 변환해서 편집하고, **pd.DataFrame()**를 호출하여 편집완료된 list값을 pandas 형태로 바꾸고, to_csv를 최종적으로 호출하여 CSV형태로 DISK에 저장합니다.

크게 유용한 메서드는 다음과 같습니다.

Open_and_Setting() 메서드는 현재 CSV의 모양을 추출합니다.

**[1/4]Open_and_Setting()**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/6081454044e4a6f843a8238f466f8de22bf021fe/MAIN/Parsing_CSV.py#L16

APPEND_row() 메서드는 맨 아래에 행을 APPEND합니다.

**[2/4]APPEND_row()**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/6081454044e4a6f843a8238f466f8de22bf021fe/MAIN/Parsing_CSV.py#L79

Output_one_row() 메서드는 특정한 hint를 받아, 그것에 일치한 row 하나를 리턴합니다. ( 데이터 존재하는지 아닌지 확인하는데 사용하기 좋습니다. )

**[3/4]Output_one_row()**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/6081454044e4a6f843a8238f466f8de22bf021fe/MAIN/Parsing_CSV.py#L99

Rewrite_to_Csv() 메서드는 특정 행의 값을 바꾸거나(갱신), 끼워넣기가 가능합니다. ( 현재, is_ALL_change를 TRUE로 하지않는 것이 좋습니다. )

**[4/4]Rewrite_to_Csv()**

https://github.com/lastime1650/AI_based_Malware_Detection_with_VirusTotal/blob/6081454044e4a6f843a8238f466f8de22bf021fe/MAIN/Parsing_CSV.py#L112C9-L112C23

<br/><br/>
<br/><br/>



